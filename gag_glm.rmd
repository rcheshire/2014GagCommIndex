2014 Gag Commercial Handline Index of Abundance
========================================================

The 2014 update of the SEDAR 10 (2006) South Atlantic gag stock assessment requires recomputation of the commercial handline index of abundance.  The entire time series must be evaluated as recent trends will influence predictions for previous years.  This document describes changes to the methods as well as consideration of the influence of management decisions. 

**Changes from the SEDAR 10 approach**

1.  The Stephens and MacCall method for determining trips with effort in gag habitat but no catch was modified to exclude associated species with prolonged closures during part of the time series (red porgy and red snapper). The species used as factors to determine the probability of catching gag in a trip was defined as those caught in 1% of trips.  SEDAR 10 used a 5% cutoff.  


2.  The starting year for the index was changed from 1992 to 1993.  The 1992 commercial logbook data collection was voluntary.  For this reason 1992 has been excluded from all recent SEDAR assessed species.


3.  The factor for region was aggregated over the Latitude-level used in SEDAR 10 to 3 levels (North Carolina, South Carolina, and Georgia-North Florida).  This change was made to accomodate smaller samples sizes for reduced data sets discussed below.


4.  Management closures to the gag fishery occured for spawning (Jan-Apr) starting in 2010 and in October 2012 for the quota.  Three options for accounting for these changes were evaluated.  (The SEDAR 10 analysis excluded March and April due to a recreational bag limit imposed on commercial fisheries starting in 1999.) 

  *method1: 1993-2009 including all months (most similar to SEDAR 10 index)
  
  *method2:  1993-2011 excluding Jan-Apr trips (allows for longer time series and accounts for spawning closure)
  
  *method3:  1993-2012 excluding Jan-Apr trips and Oct-Dec trips  (allows for full time series and removes bias associated with spawning closure and quota closure)







```{r dataprep, warning=FALSE,message=FALSE,echo=FALSE}
windows(record=T,w=7,h=5.5)
library(MASS)
require(doBy)
require(xtable)
library(matlab)
source('sort.data.frame.r')
input='W:/SEDAR/Updates2014/Gag/Indicies/CommHL'
s10indexYr=1993:2004
s10index=c(0.944,0.907,0.937,1.001,0.768,0.951,1.017,0.912,0.867,1.006,1.342,1.44)
s10indexPred=c(0.86,1.03,1.06,0.92,0.83,0.86,0.98,1.02,0.95,1.05,1.24,1.32)
gagtrips=read.csv(paste(input,'landbymonth.csv',sep='/'),header=TRUE)
#create trip sample size for each method
method1=summaryBy(X_FREQ_~year,data=gagtrips[gagtrips$month%in%c(1,4,5,6,7,8,9,10,11,12),],FUN=sum)
colnames(method1)=c('year','method1')
for(i in 1:dim(method1)[1]){
if(method1$year[i]>2009){method1$method1[i]='NA'}
}
method2=summaryBy(X_FREQ_~year,data=gagtrips[gagtrips$month%in%5:12,],FUN=sum)
colnames(method2)=c('year','method2')
for(i in 1:dim(method2)[1]){
if(method2$year[i]>2011){method2$method2[i]='NA'}
}
method3=summaryBy(X_FREQ_~year,data=gagtrips[gagtrips$month%in%c(5,6,7,8,9),],FUN=sum)
colnames(method3)=c('year','method3')


```

**Table 1.** Commercial handline trips through 2009 for all months (method1), through 2011 without Jan-Apr (method2), and through 2012 with only May-Sep (method3).

```{r sample size, warning=FALSE,message=FALSE,results='asis',echo=FALSE}
sstable=cbind(method1$year,method1$method1,method2$method2,method3$method3)
sstable=as.data.frame.matrix(sstable)
colnames(sstable)=c('year','method1','method2','method3')
sstable=xtable(sstable,digits=0,display=c('d','d','d','d','d'),align=c('r','r','r','r','r'))
print(sstable,type="html",include.rownames=FALSE)
```

```{r binaryMatrixm1,warning=FALSE,message=FALSE, echo=FALSE}
###########Create Binary Matrix for Stephens and MacCall#####

####################METHOD 1. Jan,Feb, May,Jun,JUl,Aug,Sept,Oct,Nov,Dec through 2009##########
dat=read.csv('W:/SEDAR/Updates2014/Gag/Indicies/CommHL/tripspeciesm1.csv',header=T)
NMFSspp.codes=read.csv('W:/SEDAR/Updates2014/Gag/Indicies/CommHL/NMFSsppcodes.csv',header=T)
spp.codes=sort.data.frame(NMFSspp.codes,~sppcode)

trips=unique(dat$SCHEDULE)
spp.id=spp.codes$sppcode
spp.name=spp.codes$name

mat=matrix(0, nrow=length(trips),ncol=length(spp.id),
              dimnames=list(trip=trips,names=spp.name))
#instead of ind, this could be done using the fcn "match"
ind=1
for (j in 1:length(spp.id)) {
    if (dat$species[1]==spp.id[j]) mat[ind,j]=1
}
tic()
for (i in 2:nrow(dat)) {
    if (dat$SCHEDULE[i]!=dat$SCHEDULE[i-1]) {
        ind=ind+1
    }
    for (j in 1:length(spp.id)) {
           if (dat$species[i]==spp.id[j]) mat[ind,j]=1
    }

}
toc()
tic()
write.table(mat,file='W:/SEDAR/Updates2014/Gag/Indicies/CommHL/lgbkm1.dat',quote=F,sep=",")
toc()

#Fit logistic regression to select trips that may have caught focal species
#Implement method from Stephens and McCall.2004. Fisheries Research.
#Kyle Shertzer, 10/24/05
#Last updated, 2/13/2014
#2014 gag update - RTC

#graphics.off()
#rm(list=ls(all=TRUE))
bin.dat=mat
colnames(bin.dat)=make.names(colnames(bin.dat))
bin.dat=as.data.frame.matrix(bin.dat)
#read.csv("BinaryMatrix_HLM.csv", header=TRUE)
bin.dat[is.na(bin.dat)] <- 0
# Remove red snapper and red porgy due to closures
bin.dat=subset(bin.dat,select=-c(Red.snapper,Red.porgy))



################## regression coefficients by species###

target.spp="Gag"
target.spp2="Gag"
target.code=1423

incidence=data.frame(freq=colSums(bin.dat[,-1],na.rm=TRUE))
incidence$prop.trps=incidence$freq/sum(incidence$freq)

#----define species to be used in GLM-----                 
#minimal proportion of trips in which a species is caught
cutoff=0.01     #0.05
incidence=incidence[incidence$prop.trps>cutoff,]
mat2=bin.dat[,rownames(incidence)]
mat2=as.data.frame.matrix(mat2)
#creage scatter plot of target to other species 
#look for combinations with no overlap and remove
# windows(height=8,width=10,record=T)
# par(mfrow=c(2,4))
# for(i in 2:dim(mat2)[2]){
# with(mat2,plot(jitter(Gag),jitter(mat2[,i]),ylab=colnames(mat2[i]), xlab=target.spp))
# }


#species removed (usually because they never co-occur with target species)
#species to remove: 
#mat2=mat2[,-c(4)]
#mat2=cbind(bin.dat$SCHEDULE,mat2)
totals=colSums(mat2,na.rm=TRUE)
```
Figure 1.  Method 1:  Estimates of species-specific regression coefficients used to estimate a trip's probability of catching gag.
```{r regcoeffm1,warning=FALSE,message=FALSE,echo=FALSE,results='hide'}
##incidence2=data.frame(name=spp.name[incidence$prop.trps>cutoff],
##            freq=totals,prop.trps=totals/nrow(mat2))
###incidence2.sort=orderBy(~freq,incidence2)
##sp.names=spp.name[incidence$prop.trps>cutoff]
#

#-----fit binomial GLM-----
mat2.df=data.frame(mat2)
id=1:length(colnames(mat2.df))
id.target= id[colnames(mat2.df)==target.spp]
terms.glm=""
for (i in 1:length(id)) {
    if (i!=id.target){
      if (i==1) terms.glm=paste(terms.glm,colnames(mat2.df)[i],sep="")
      else terms.glm=paste(terms.glm,colnames(mat2.df)[i],sep="+")
    }
}
#fit the model and use step-wise AIC to choose species to include
model=paste(colnames(mat2.df)[id.target],terms.glm,sep="~")
glm.start <- glm(formula=as.formula(model),family="binomial", data=mat2.df)
glm.step <- stepAIC(glm.start,scope=list(upper = paste('~',terms.glm),lower = ~1),direction="backward")
fit=glm.step
#fit=glm(formula=as.formula(model),family=binomial, data=mat2.df)

coeff=sort(fit$coefficients[-1], decreasing=T)
```

```{r regcoeffPlotm1,warning=FALSE,message=FALSE,echo=FALSE}
windows(width=10,height=8,record=T)
par(las=2,cex.lab=1.0,oma=c(0,15,0,0))
barplot(coeff,horiz=T,xlim=c(-1.0,1), xlab='Regression coefficient')
savePlot(file="sppcorr.pdf",type="pdf")
savePlot(file="sppcorr.png",type="png")

```
Figure 2.  Method 1:  Absolute difference between observed and predicted number of positive gag trips.  Left and right panels differ only in the range of probabilities shown.

```{r probabilitym1,warning=FALSE,message=FALSE,echo=FALSE}
#-----evaluate predictions/ choose trips ------------
gt.func=function(x) length(fit$fitted.values[fit$fitted.values>x])
prob.trp=seq(0,1,by=0.001)
num.postrips.pred=rep(0,length(prob.trp))
for (i in 1:length(prob.trp)){num.postrips.pred[i]=gt.func(prob.trp[i])}

abs.dif=abs(num.postrips.pred-totals[target.spp])
windows(width=8,height=4,record=T)
par(mfcol=c(1,2),mar=c(4,4,1.5,0.5),las=2)
plot(prob.trp,abs.dif/1000,type="l",xlab="Probability",main="",ylab="Abs. error (1000)")
min.prob=mean(prob.trp[abs.dif==min(abs.dif)]) #mean in case min is not unique
plot(prob.trp[600:620],abs.dif[600:620]/1000,type="l",
     xlab="Probability", ylab="Abs. error (1000)")
savePlot(file="minimum.pdf",type="pdf")
savePlot(file="minimum.png",type="png")
```

```{r binaryMatrixm2,warning=FALSE,message=FALSE, echo=FALSE}
####################METHOD 2.  May,Jun,JUl,Aug,Sept,Oct,Nov,Dec through 2011##########
dat=read.csv('W:/SEDAR/Updates2014/Gag/Indicies/CommHL/tripspeciesm2.csv',header=T)
spp.codes=sort.data.frame(NMFSspp.codes,~sppcode)

trips=unique(dat$SCHEDULE)
spp.id=spp.codes$sppcode
spp.name=spp.codes$name

mat=matrix(0, nrow=length(trips),ncol=length(spp.id),
              dimnames=list(trip=trips,names=spp.name))
#instead of ind, this could be done using the fcn "match"
ind=1
for (j in 1:length(spp.id)) {
    if (dat$species[1]==spp.id[j]) mat[ind,j]=1
}
tic()
for (i in 2:nrow(dat)) {
    if (dat$SCHEDULE[i]!=dat$SCHEDULE[i-1]) {
        ind=ind+1
    }
    for (j in 1:length(spp.id)) {
           if (dat$species[i]==spp.id[j]) mat[ind,j]=1
    }

}
toc()
tic()
write.table(mat,file='W:/SEDAR/Updates2014/Gag/Indicies/CommHL/m2.dat',quote=F,sep=",")
toc()

#Fit logistic regression to select trips that may have caught focal species
#Implement method from Stephens and McCall.2004. Fisheries Research.
#Kyle Shertzer, 10/24/05
#Last updated, 2/13/2014
#2014 gag update - RTC

#graphics.off()
#rm(list=ls(all=TRUE))
bin.dat=mat
colnames(bin.dat)=make.names(colnames(bin.dat))
bin.dat=as.data.frame.matrix(bin.dat)
#read.csv("BinaryMatrix_HLM.csv", header=TRUE)
bin.dat[is.na(bin.dat)] <- 0
# Remove red snapper and red porgy due to closures
bin.dat=subset(bin.dat,select=-c(Red.snapper,Red.porgy))



################## regression coefficients by species###

target.spp="Gag"
target.spp2="Gag"
target.code=1423

incidence=data.frame(freq=colSums(bin.dat[,-1],na.rm=TRUE))
incidence$prop.trps=incidence$freq/sum(incidence$freq)

#----define species to be used in GLM-----                 
#minimal proportion of trips in which a species is caught
cutoff=0.01     #0.05
incidence=incidence[incidence$prop.trps>cutoff,]
mat2=bin.dat[,rownames(incidence)]
mat2=as.data.frame.matrix(mat2)
#creage scatter plot of target to other species 
#look for combinations with no overlap and remove
# windows(height=8,width=10,record=T)
# par(mfrow=c(2,4))
# for(i in 2:dim(mat2)[2]){
# with(mat2,plot(jitter(Gag),jitter(mat2[,i]),ylab=colnames(mat2[i]), xlab=target.spp))
# }


#species removed (usually because they never co-occur with target species)
#species to remove: 
#mat2=mat2[,-c(4)]
#mat2=cbind(bin.dat$SCHEDULE,mat2)
totals=colSums(mat2,na.rm=TRUE)
```
Figure 3.  Method 2: Estimates of species-specific regression coefficients used to estimate a trip's probability of catching gag.
```{r regcoeffm2,warning=FALSE,message=FALSE,echo=FALSE,results='hide'}
##incidence2=data.frame(name=spp.name[incidence$prop.trps>cutoff],
##            freq=totals,prop.trps=totals/nrow(mat2))
###incidence2.sort=orderBy(~freq,incidence2)
##sp.names=spp.name[incidence$prop.trps>cutoff]
#

#-----fit binomial GLM-----
mat2.df=data.frame(mat2)
id=1:length(colnames(mat2.df))
id.target= id[colnames(mat2.df)==target.spp]
terms.glm=""
for (i in 1:length(id)) {
    if (i!=id.target){
      if (i==1) terms.glm=paste(terms.glm,colnames(mat2.df)[i],sep="")
      else terms.glm=paste(terms.glm,colnames(mat2.df)[i],sep="+")
    }
}
#fit the model and use step-wise AIC to choose species to include
model=paste(colnames(mat2.df)[id.target],terms.glm,sep="~")
glm.start <- glm(formula=as.formula(model),family="binomial", data=mat2.df)
glm.step <- stepAIC(glm.start,scope=list(upper = paste('~',terms.glm),lower = ~1),direction="backward")
fit=glm.step
#fit=glm(formula=as.formula(model),family=binomial, data=mat2.df)

coeff=sort(fit$coefficients[-1], decreasing=T)
```

```{r regcoeffPlotm2,warning=FALSE,message=FALSE,echo=FALSE}
windows(width=10,height=8,record=T)
par(las=2,cex.lab=1.0,oma=c(0,15,0,0))
barplot(coeff,horiz=T,xlim=c(-1.0,1), xlab='Regression coefficient')
savePlot(file="sppcorr2.pdf",type="pdf")
savePlot(file="sppcorr2.png",type="png")

```
Figure 4.  Method 2: Absolute difference between observed and predicted number of positive gag trips.  Left and right panels differ only in the range of probabilities shown.

```{r probabilitym2,warning=FALSE,message=FALSE,echo=FALSE}
#-----evaluate predictions/ choose trips ------------
gt.func=function(x) length(fit$fitted.values[fit$fitted.values>x])
prob.trp=seq(0,1,by=0.001)
num.postrips.pred=rep(0,length(prob.trp))
for (i in 1:length(prob.trp)){num.postrips.pred[i]=gt.func(prob.trp[i])}

abs.dif=abs(num.postrips.pred-totals[target.spp])
windows(width=8,height=4,record=T)
par(mfcol=c(1,2),mar=c(4,4,1.5,0.5),las=2)
plot(prob.trp,abs.dif/1000,type="l",xlab="Probability",main="",ylab="Abs. error (1000)")
min.prob=mean(prob.trp[abs.dif==min(abs.dif)]) #mean in case min is not unique
plot(prob.trp[600:620],abs.dif[600:620]/1000,type="l",
     xlab="Probability", ylab="Abs. error (1000)")
savePlot(file="minimum2.pdf",type="pdf")
savePlot(file="minimum2.png",type="png")
```
```{r binaryMatrixm3,warning=FALSE,message=FALSE, echo=FALSE}

####################METHOD 2.  May,Jun,JUl,Aug,Sept,Oct,Nov,Dec through 2011##########
dat=read.csv('W:/SEDAR/Updates2014/Gag/Indicies/CommHL/tripspeciesm3.csv',header=T)
spp.codes=sort.data.frame(NMFSspp.codes,~sppcode)

trips=unique(dat$SCHEDULE)
spp.id=spp.codes$sppcode
spp.name=spp.codes$name

mat=matrix(0, nrow=length(trips),ncol=length(spp.id),
              dimnames=list(trip=trips,names=spp.name))
#instead of ind, this could be done using the fcn "match"
ind=1
for (j in 1:length(spp.id)) {
    if (dat$species[1]==spp.id[j]) mat[ind,j]=1
}
tic()
for (i in 2:nrow(dat)) {
    if (dat$SCHEDULE[i]!=dat$SCHEDULE[i-1]) {
        ind=ind+1
    }
    for (j in 1:length(spp.id)) {
           if (dat$species[i]==spp.id[j]) mat[ind,j]=1
    }

}
toc()
tic()
write.table(mat,file='W:/SEDAR/Updates2014/Gag/Indicies/CommHL/lgbkm3.dat',quote=F,sep=",")
toc()

#Fit logistic regression to select trips that may have caught focal species
#Implement method from Stephens and McCall.2004. Fisheries Research.
#Kyle Shertzer, 10/24/05
#Last updated, 2/13/2014
#2014 gag update - RTC

#graphics.off()
#rm(list=ls(all=TRUE))
bin.dat=mat
colnames(bin.dat)=make.names(colnames(bin.dat))
bin.dat=as.data.frame.matrix(bin.dat)
#read.csv("BinaryMatrix_HLM.csv", header=TRUE)
bin.dat[is.na(bin.dat)] <- 0
# Remove red snapper and red porgy due to closures
bin.dat=subset(bin.dat,select=-c(Red.snapper,Red.porgy))



################## regression coefficients by species###

target.spp="Gag"
target.spp2="Gag"
target.code=1423

incidence=data.frame(freq=colSums(bin.dat[,-1],na.rm=TRUE))
incidence$prop.trps=incidence$freq/sum(incidence$freq)

#----define species to be used in GLM-----                 
#minimal proportion of trips in which a species is caught
cutoff=0.01     #0.05
incidence=incidence[incidence$prop.trps>cutoff,]
mat2=bin.dat[,rownames(incidence)]
mat2=as.data.frame.matrix(mat2)
#creage scatter plot of target to other species 
#look for combinations with no overlap and remove
# windows(height=8,width=10,record=T)
# par(mfrow=c(2,4))
# for(i in 2:dim(mat2)[2]){
# with(mat2,plot(jitter(Gag),jitter(mat2[,i]),ylab=colnames(mat2[i]), xlab=target.spp))
# }


#species removed (usually because they never co-occur with target species)
#species to remove: 
#mat2=mat2[,-c(4)]
#mat2=cbind(bin.dat$SCHEDULE,mat2)
totals=colSums(mat2,na.rm=TRUE)
```
Figure 5.  Method 3: Estimates of species-specific regression coefficients used to estimate a trip's probability of catching gag.
```{r regcoeffm3,warning=FALSE,message=FALSE,echo=FALSE,results='hide'}
##incidence2=data.frame(name=spp.name[incidence$prop.trps>cutoff],
##            freq=totals,prop.trps=totals/nrow(mat2))
###incidence2.sort=orderBy(~freq,incidence2)
##sp.names=spp.name[incidence$prop.trps>cutoff]
#

#-----fit binomial GLM-----
mat2.df=data.frame(mat2)
id=1:length(colnames(mat2.df))
id.target= id[colnames(mat2.df)==target.spp]
terms.glm=""
for (i in 1:length(id)) {
    if (i!=id.target){
      if (i==1) terms.glm=paste(terms.glm,colnames(mat2.df)[i],sep="")
      else terms.glm=paste(terms.glm,colnames(mat2.df)[i],sep="+")
    }
}
#fit the model and use step-wise AIC to choose species to include
model=paste(colnames(mat2.df)[id.target],terms.glm,sep="~")
glm.start <- glm(formula=as.formula(model),family="binomial", data=mat2.df)
glm.step <- stepAIC(glm.start,scope=list(upper = paste('~',terms.glm),lower = ~1),direction="backward")
fit=glm.step
#fit=glm(formula=as.formula(model),family=binomial, data=mat2.df)

coeff=sort(fit$coefficients[-1], decreasing=T)
```

```{r regcoeffPlotm3,warning=FALSE,message=FALSE,echo=FALSE}
windows(width=10,height=8,record=T)
par(las=2,cex.lab=1.0,oma=c(0,15,0,0))
barplot(coeff,horiz=T,xlim=c(-1.0,1), xlab='Regression coefficient')
savePlot(file="sppcorr3.pdf",type="pdf")
savePlot(file="sppcorr3.png",type="png")

```
Figure 6.  Method 3: Absolute difference between observed and predicted number of positive gag trips.  Left and right panels differ only in the range of probabilities shown.

```{r probabilitym3,warning=FALSE,message=FALSE,echo=FALSE}
#-----evaluate predictions/ choose trips ------------
gt.func=function(x) length(fit$fitted.values[fit$fitted.values>x])
prob.trp=seq(0,1,by=0.001)
num.postrips.pred=rep(0,length(prob.trp))
for (i in 1:length(prob.trp)){num.postrips.pred[i]=gt.func(prob.trp[i])}

abs.dif=abs(num.postrips.pred-totals[target.spp])
windows(width=8,height=4,record=T)
par(mfcol=c(1,2),mar=c(4,4,1.5,0.5),las=2)
plot(prob.trp,abs.dif/1000,type="l",xlab="Probability",main="",ylab="Abs. error (1000)")
min.prob=mean(prob.trp[abs.dif==min(abs.dif)]) #mean in case min is not unique
plot(prob.trp[600:620],abs.dif[600:620]/1000,type="l",
     xlab="Probability", ylab="Abs. error (1000)")
savePlot(file="minimum3.pdf",type="pdf")
savePlot(file="minimum3.png",type="png")
```

